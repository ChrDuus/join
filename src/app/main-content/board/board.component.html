<main class="main-container">
  <header class="header">
    <h1 class="title">Board</h1>

    <div class="right-section">
      <div class="search-input-wrapper" [class.active-wrapper]="isActive">
        <input
          type="text"
          placeholder="Find Task"
          class="search-input"
          [(ngModel)]="searchQuery"
          (input)="onInputChange($event, searchQuery)"
        />
        <span class="separator">|</span>
        <button class="search-button" (click)="toggleActive()">
          <img src="assets/img/board/search.svg" alt="Search" />
        </button>
      </div>

      <button
        (click)="setNewTaskStatus('ToDo'); overlayService.openOverlay('add-task')"
        class="add-task-button create-button"
      >
        Add task
        <img src="assets/img/board/plus.svg" alt="Add Task" />
      </button>
    </div>
  </header>

  <div class="columns-container">
    <div class="columns-content">

      <div class="column">
        <div class="column-header">
          <div class="column-title">
            <span>To Do</span>
            <button (click)="setNewTaskStatus('ToDo'); overlayService.openOverlay('add-task')" class="add-button">
              <img src="assets/img/board/plus.svg" alt="Add" />
            </button>
          </div>
        </div>
        <div class="tasks-container">

          @if (taskService.tasksList) {
            @for (task of taskService.tasksList; track task.id) {
              @if(task.status == 'ToDo' && (task.title.startsWith(taskService.searchInputFieldValue) || task.description.startsWith(taskService.searchInputFieldValue))){
                <div class="task-card" (click)="openTaskDetail(task)">
                  <div class="task-category">{{ task.category }}</div>
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-description">
                    {{
                      task.description
                        ? (task.description.length > 50
                            ? task.description.substring(0, 50) + '...'
                            : task.description)
                        : ''
                    }}
                  </div>
  
                  @if (task.subtasks && task.subtasks.length > 0) {
                    <div class="progress-container">
                      <div class="progress-track">
                        <div class="progress-bar" [style.width.%]="getProgressWidth(task)"></div>
                      </div>
                      <span class="progress-text"> {{ getCompletedSubtasks(task) }}/{{ task.subtasks.length || 0 }} Subtasks</span>
                      </div>
                  }
  
                  <div class="task-footer">
                    <div class="task-assigned">
                      @for (assignee of task.assignedTo; track assignee.id) {
                        <div
                          class="assigned-contact"
                          [ngStyle]="{ background: assignee.color }"
                        >
                          {{ assignee.letters }}
                        </div>
                      }
                    </div>
                    <div class="task-priority">
                      @if (task.priority === 'Urgent') {
                        <img
                          src="assets/img/2-add-task/urgent-icon.svg"
                          alt="urgent"
                        />
                      } @else if (task.priority === 'Medium') {
                        <img
                          src="assets/img/2-add-task/medium-icon.svg"
                          alt="medium"
                        />
                      } @else if (task.priority === 'Low') {
                        <img
                          src="assets/img/2-add-task/low-icon.svg"
                          alt="low"
                        />
                      }
                    </div>
                  </div>
                </div>
              }
            }
          } @else {
            <div class="dashed-container">
              <span>No tasks To do</span>
            </div>
          }
        </div>
      </div>

      <div class="column">
        <div class="column-header">
          <div class="column-title">
            <span>In Progress</span>
            <button class="add-button" (click)="setNewTaskStatus('In Progress'); overlayService.openOverlay('add-task')">
              <img src="assets/img/board/plus.svg" alt="Add" />
            </button>
          </div>
        </div>
        <div class="tasks-container">

          @if (taskService.tasksList) {
            @for (task of taskService.tasksList; track task) {
              @if(task.status == 'In Progress' && (task.title.startsWith(taskService.searchInputFieldValue) || task.description.startsWith(taskService.searchInputFieldValue))){
                <div class="task-card" (click)="openTaskDetail(task)">
                  <div class="task-category">{{ task.category }}</div>
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-description">
                    {{
                      task.description
                        ? (task.description.length > 50
                            ? task.description.substring(0, 50) + '...'
                            : task.description)
                        : ''
                    }}
                  </div>
  
                  @if (task.subtasks && task.subtasks.length > 0) {
                    <div class="task-progress">
                      {{ task.subtasks.length }} Subtasks
                    </div>
                  }
  
                  <div class="task-footer">
                    <div class="task-assigned">
                      @for (assignee of task.assignedTo; track assignee.id) {
                        <div
                          class="assigned-contact"
                          [ngStyle]="{ background: assignee.color }"
                        >
                          {{ assignee.letters }}
                        </div>
                      }
                    </div>
                    <div class="task-priority">
                      @if (task.priority === 'Urgent') {
                        <img
                          src="assets/img/2-add-task/urgent-icon.svg"
                          alt="urgent"
                        />
                      } @else if (task.priority === 'Medium') {
                        <img
                          src="assets/img/2-add-task/medium-icon.svg"
                          alt="medium"
                        />
                      } @else if (task.priority === 'Low') {
                        <img
                          src="assets/img/2-add-task/low-icon.svg"
                          alt="low"
                        />
                      }
                    </div>
                  </div>
                </div>
              }
            }
          } @else {
            <div class="dashed-container">
              <span>No tasks To do</span>
            </div>
          }
        </div>
      </div>

      <div class="column">
        <div class="column-header">
          <div class="column-title">
            <span>Await Feedback</span>
            <button class="add-button" (click)="setNewTaskStatus('Await Feedback'); overlayService.openOverlay('add-task')">
              <img src="assets/img/board/plus.svg" alt="Add" />
            </button>
          </div>
        </div>
        <div class="tasks-container">

          @if (taskService.tasksList) {
            @for (task of taskService.tasksList; track task) {
              @if(task.status == 'Await Feedback' && (task.title.startsWith(taskService.searchInputFieldValue) || task.description.startsWith(taskService.searchInputFieldValue))){
                <div class="task-card" (click)="openTaskDetail(task)">
                  <div class="task-category">{{ task.category }}</div>
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-description">
                    {{
                      task.description
                        ? (task.description.length > 50
                            ? task.description.substring(0, 50) + '...'
                            : task.description)
                        : ''
                    }}
                  </div>
  
                  @if (task.subtasks && task.subtasks.length > 0) {
                    <div class="task-progress">
                      {{ task.subtasks.length }} Subtasks
                    </div>
                  }
  
                  <div class="task-footer">
                    <div class="task-assigned">
                      @for (assignee of task.assignedTo; track assignee.id) {
                        <div
                          class="assigned-contact"
                          [ngStyle]="{ background: assignee.color }"
                        >
                          {{ assignee.letters }}
                        </div>
                      }
                    </div>
                    <div class="task-priority">
                      @if (task.priority === 'Urgent') {
                        <img
                          src="assets/img/2-add-task/urgent-icon.svg"
                          alt="urgent"
                        />
                      } @else if (task.priority === 'Medium') {
                        <img
                          src="assets/img/2-add-task/medium-icon.svg"
                          alt="medium"
                        />
                      } @else if (task.priority === 'Low') {
                        <img
                          src="assets/img/2-add-task/low-icon.svg"
                          alt="low"
                        />
                      }
                    </div>
                  </div>
                </div>
              }
            }
          } @else {
            <div class="dashed-container">
              <span>No tasks To do</span>
            </div>
          }
        </div>
      </div>

      <div class="column">
        <div class="column-header">
          <div class="column-title">
            <span>Done</span>
          </div>
        </div>
        <div class="tasks-container">

          @if (taskService.tasksList) {
            @for (task of taskService.tasksList; track task) {
              @if(task.status == 'Done' && (task.title.startsWith(taskService.searchInputFieldValue) || task.description.startsWith(taskService.searchInputFieldValue))){
                <div class="task-card" (click)="openTaskDetail(task)">
                  <div class="task-category">{{ task.category }}</div>
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-description">
                    {{
                      task.description
                        ? (task.description.length > 50
                            ? task.description.substring(0, 50) + '...'
                            : task.description)
                        : ''
                    }}
                  </div>
  
                  @if (task.subtasks && task.subtasks.length > 0) {
                    <div class="task-progress">
                      {{ task.subtasks.length }} Subtasks
                    </div>
                  }
  
                  <div class="task-footer">
                    <div class="task-assigned">
                      @for (assignee of task.assignedTo; track assignee.id) {
                        <div
                          class="assigned-contact"
                          [ngStyle]="{ background: assignee.color }"
                        >
                          {{ assignee.letters }}
                        </div>
                      }
                    </div>
                    <div class="task-priority">
                      @if (task.priority === 'Urgent') {
                        <img
                          src="assets/img/2-add-task/urgent-icon.svg"
                          alt="urgent"
                        />
                      } @else if (task.priority === 'Medium') {
                        <img
                          src="assets/img/2-add-task/medium-icon.svg"
                          alt="medium"
                        />
                      } @else if (task.priority === 'Low') {
                        <img
                          src="assets/img/2-add-task/low-icon.svg"
                          alt="low"
                        />
                      }
                    </div>
                  </div>
                </div>
              }
            }
          } @else {
            <div class="dashed-container">
              <span>No tasks To do</span>
            </div>
          }
        </div>
      </div>

    </div>
  </div>
</main>
